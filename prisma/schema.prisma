// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  DEVELOPER
  ADMIN
}

enum TransactionStatus {
  CREATED           // 1. المبرمج عمل المشروع
  PAYMENT_VERIFYING // 2. العميل رفع صورة التحويل وبنراجعها
  IN_PROGRESS       // 3. الفلوس وصلت والشغل بدأ
  IN_REVIEW         // 4. المبرمج رفع "البريفيو" (فيديو/صور)
  COMPLETED         // 5. العميل وافق واستلم الكود والفلوس وصلت للمبرمج
  CANCELLED         // 6. المشروع اتلغى (حسب شروط الاسترجاع)
}

enum CancelledBy {
  CLIENT
  DEVELOPER
  ADMIN
}

// 3. جدول المستخدمين (بنربطه مع Clerk)
model User {
  id        String   @id // هنا هنخزن الـ ID اللي جاي من Clerk (مش uuid عشوائي)
  email     String   @unique
  name      String?
  role      UserRole @default(CLIENT)
  
  // علاقات المستخدم بالمشاريع
  clientTransactions    Transaction[] @relation("ClientProjects")
  developerTransactions Transaction[] @relation("DeveloperProjects")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 4. جدول المعاملات (المشروع نفسه)
model Transaction {
  id          String            @id @default(cuid()) // ID مميز للمشروع
  title       String
  description String?
  price       Decimal           @db.Decimal(10, 2) // عشان الفلوس لازم دقة عالية
  
  // المواعيد
  deadline    DateTime          // أهم حقل عشان حساب الغرامة
  
  // الحالة
  status      TransactionStatus @default(CREATED)
  
  // ملفات وإثباتات (هنا هنشيل لينكات الصور اللي جاية من UploadThing)
  paymentReceiptUrl String?     // صورة وصل التحويل البنكي
  previewUrl        String?     // فيديو أو صور للمعاينة (المرحلة 5)
  finalSourceUrl    String?     // لينك تحميل الكود النهائي (المرحلة 7)
  
  // منطق الإلغاء
  cancelledBy       CancelledBy?
  refundPercentage  Int?        // 50 أو 100
  cancellationReason String?

  // العلاقات (مين المبرمج ومين العميل)
  developerId String
  developer   User   @relation("DeveloperProjects", fields: [developerId], references: [id])
  
  clientId    String? // ممكن يكون فاضي في الأول لحد ما العميل يدخل
  client      User?   @relation("ClientProjects", fields: [clientId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}